4. Testing Timings
==================

.. code-block:: python

    model = ResUNet()
    model = model.to(device)
    lossfn = nn.BCEWithLogitsLoss()

    optimizer = torch.optim.Adam(model.parameters(), lr=1e-2)

    meow = torch.utils.data.Subset(train_subset, range(0, len(train_subset)//1))
    meow_loader = torch.utils.data.DataLoader(meow, batch_size=128, shuffle=True, num_workers=2, pin_memory=True)
    pbar = tqdm(meow_loader, dynamic_ncols=True)

    other_time = 0

    start = time()

    other_s = time()
    model.train()
    other_e = time()

    other_time += other_e - other_s

    data_load_time = 0
    model_time = 0

    meow_time = 0

    for batch_idx, data in enumerate(pbar):

        other_s = time()
        optimizer.zero_grad()
        other_e = time()

        other_time += other_e - other_s

        load_s = time()

        data['bg'] = data['bg'].to(device)
        data['fg_bg'] = data['fg_bg'].to(device)
        data['depth_fg_bg'] = data['depth_fg_bg'].to(device)
        data['fg_bg_mask'] = data['fg_bg_mask'].to(device)

        load_e = time()

        data_load_time += load_e - load_s

        model_s = time() # model start

        x = torch.cat([data['bg'], data['fg_bg']], dim=1)
        d_out, s_out = model(x)

        l1 = lossfn(d_out, data['depth_fg_bg'])
        l2 = lossfn(s_out, data['fg_bg_mask'])

        loss = 2*l1 + l2

        loss.backward()
        optimizer.step()
        model_e = time() # model end

        model_time += model_e - model_s

        other_s = time()

        pbar.set_description(desc=f'loss={loss.item():.10f} batch_id={batch_idx}')


        # del data # and this shit was taking 0.07% of mah time
        if batch_idx % 200 == 0:
            torch.cuda.empty_cache() # this shit takes 8% of my frikking time

        other_e = time()

        other_time += other_e - other_s
    end = time()

    print(f'total time : {end-start:.4f} s')
    print(f'the model took : {model_time:.4f} s i.e. {(model_time / (end - start)):.4f} % of total execution')
    print(f'data loading took : {data_load_time:.4f} s i.e. {(data_load_time / (end - start)):.4f} % of total execution')
    print(f'others took : {other_time:.4f} s i.e. {(other_time / (end - start)):.4f} % of total execution')



OUTPUT

.. code-block:: none

    total time : 2331.8488 s
    the model took : 2289.7168 s i.e. 0.9819 % of total execution
    data loading took : 10.2884 s i.e. 0.0044 % of total execution
    others took : 28.5874 s i.e. 0.0123 % of total execution